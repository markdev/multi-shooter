<!doctype html>
<html>
  <head>
    <title>Spacefish Multiplayer</title>
    <style>
      * { margin: 0; padding: 0; box-sizing: border-box; color: #fff;}
      body { font: 13px Helvetica, Arial; background-color: #000;}
      h1 {text-align: center; font-size: 4em; padding: 20px 0px;}
      div#signupScreen {text-align: center;}
      input#playerName {margin: auto; text-align: center; width: 80%; height: 10%; font-size: 6em; color: #800; margin: 40px 0px;}
      button#playerNameSubmit { width: 60%; font-size: 4em;}
      .gameScreen {display: none;}
    </style>
    <script src="https://cdn.socket.io/socket.io-1.2.0.js"></script>
    <script src="http://code.jquery.com/jquery-1.11.1.js"></script>
  </head>
  <body>

    <div class="gameScreen" id="signupScreen">
      <h1>Welcome to Spacefish!</h1>
      <h1>Enter your name:</h1>
      <h2 class="errorMessage"></h2>
      <input id="playerName" />
      <br/>
      <button id="playerNameSubmit">Enter</button>
      <br/>
      <span id="currentPlayers"></span>
    </div>

    <div class="gameScreen" id="calibrationScreen">
      <h1>Calibrating Your Device</h1>
      <h1 id="calibrationCount">5</h1>
      <h1>Hold Still!</h1>
    </div>

    <div class="gameScreen" id="gameplayScreen">
      <h1>Game on</h1>
    </div>

    <div class="gameScreen" id="resultsScreen">
    </div>

    <script>
      var socket = io();
      socket.emit('initialize', 'hello world');
      $('#signupScreen').css('display', 'block')

      /*************** 
        Socket Events 
      ***************/
      socket.on('playerList', function(players) {
        var playerString = "Currently Playing: ";
        if (players.length == 0) {
          playerString += "no one yet";
        } else {
          playerString += players.join(", ");
        }
        $('#currentPlayers').html(playerString);
      });

      socket.on('signup error', function(message) { 
        gameError(message);
      });

      socket.on('signup successful', function(nickname) {
        $('#signupScreen').css('display', 'none');
        $('#calibrationScreen').css('display', 'block');
        calibrate();
      });

      socket.on('player created', function(data) {
        console.log(data);
        $('#calibrationScreen').css('display', 'none');
        $('#gameplayScreen').css('display', 'block');
      });

      /*************** 
        jQuery Events 
      ***************/
      $('#playerNameSubmit').click(function() {
        var username = $('#playerName').val().trim();
        if (username == "") {
          gameError("Please enter a user name");
        } else {
          socket.emit('signup', username);
        }
      });

      /*************** 
          Functions 
      ***************/
      function gameError(message) {
        $('.errorMessage').html(message);
      }

      function calibrate() {
        // wait three seconds, then tally two seconds of holding
        var count = 4;
        var xs = [];
        var ys = [];

        function addCalibration(event) {
          xs.push(event.beta);
          ys.push(event.gamma);         
        }
        function tick() {
          $('#calibrationCount').html(count);
          count--;          
        }
        var countdown = setInterval(tick, 1000);
        setTimeout(function(){
          console.log("now calibrating");
          window.addEventListener('deviceorientation', addCalibration);
        }, 3000);
        setTimeout(function(){
          window.removeEventListener('deviceorientation', addCalibration);
          clearInterval(countdown);
          var avgX = (xs.reduce(function(a,b){return a+b;}) / xs.length);
          var avgY = (ys.reduce(function(a,b){return a+b;}) / ys.length);
          socket.emit('start game');
        }, 5000);
      }

      function handleOrientation(event) {
        var x = event.beta;  // In degree in the range [-180,180]
        var y = event.gamma; // In degree in the range [-90,90]

        console.log(x);
        console.log(y);

        socket.emit('x', x);
        socket.emit('y', y);
      }

      //window.addEventListener('deviceorientation', handleOrientation);
    </script>
  </body>
</html>
