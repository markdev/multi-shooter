<!doctype html>
<html>
  <head>
    <title>Spacefish Multiplayer</title>
    <style>
      * { margin: 0; padding: 0; box-sizing: border-box; color: #fff;}
      body { font: 13px Helvetica, Arial; background-color: #000;}
      h1 {text-align: center; font-size: 4em; padding: 20px 0px;}
      div#signupScreen {text-align: center;}
      input#playerName {margin: auto; text-align: center; width: 80%; height: 10%; font-size: 6em; color: #800; margin: 40px 0px;}
      button#playerNameSubmit { width: 60%; font-size: 4em;}
      .gameScreen {display: none;}
    </style>
    <script src="https://cdn.socket.io/socket.io-1.2.0.js"></script>
    <script src="http://code.jquery.com/jquery-1.11.1.js"></script>
  </head>
  <body>

    <div class="gameScreen" id="signupScreen">
      <h1>Welcome to Spacefish!</h1>
      <h1>Enter your name:</h1>
      <h2 class="errorMessage"></h2>
      <input id="playerName" />
      <br/>
      <button id="playerNameSubmit">Enter</button>
      <br/>
      <span id="currentPlayers"></span>
    </div>

    <div class="gameScreen" id="calibrationScreen">
      <h1>Calibrating Your Device</h1>
      <h1 id="calibrationCount">5</h1>
      <h1>Hold Still!</h1>
    </div>

    <div class="gameScreen" id="gameplayScreen">
      <canvas id="gameCanvas"></canvas>
    </div>

    <div class="gameScreen" id="resultsScreen">
    </div>

    <script>
      /********************* 
        Game Initialization
      *********************/
      var socket = io();
      socket.emit('initialize', 'hello world');
      $('#signupScreen').css('display', 'block')

      var canvas,     // Canvas DOM element
          ctx,        // Canvas rendering context
          localRefX,
          localRefY,
          velX = 0,
          velY = 0,
          playerData,
          players,
          testplayer
      ;



      /********************* 
          Socket Events 
      *********************/
      socket.on('playerList', function(players) {
        var playerString = "Currently Playing: ";
        if (players.length == 0) {
          playerString += "no one yet";
        } else {
          playerString += players.join(", ");
        }
        $('#currentPlayers').html(playerString);
      });

      socket.on('signup error', function(message) { 
        gameError(message);
      });

      socket.on('signup successful', function(nickname) {
        $('#signupScreen').css('display', 'none');
        $('#calibrationScreen').css('display', 'block');
        calibrate();
      });

      socket.on('player created', function(data) {
        playerData = data;
        $('#calibrationScreen').css('display', 'none');
        $('#gameplayScreen').css('display', 'block');
        gameInit();
      });

      socket.on('update players', function(playersList) {
        players = playersList;
      });



      /********************* 
          jQuery Events 
      *********************/
      $('#playerNameSubmit').click(function() {
        var username = $('#playerName').val().trim();
        if (username == "") {
          gameError("Please enter a user name");
        } else {
          socket.emit('signup', username);
        }
      });



      /********************* 
            Functions 
      *********************/
      function gameError(message) {
        $('.errorMessage').html(message);
      }

      function calibrate() {
        // wait three seconds, then tally two seconds of holding
        var count = 4;
        var xs = [];
        var ys = [];

        function addCalibration(event) {
          xs.push(event.beta);
          ys.push(event.gamma);         
        }
        function tick() {
          $('#calibrationCount').html(count);
          count--;          
        }
        var countdown = setInterval(tick, 1000);
        setTimeout(function(){
          console.log("now calibrating");
          window.addEventListener('deviceorientation', addCalibration);
        }, 3000);
        setTimeout(function(){
          window.removeEventListener('deviceorientation', addCalibration);
          clearInterval(countdown);
          localRefX = Math.round((xs.reduce(function(a,b){return a+b;}) / xs.length));
          localRefY = Math.round((ys.reduce(function(a,b){return a+b;}) / ys.length));
          socket.emit('start game');
        }, 5000);
      }


      function gameInit() {
        // Good ol' requestAnimFrame
        window.requestAnimFrame = (function(){
          return  window.requestAnimationFrame  || 
          window.webkitRequestAnimationFrame    || 
          window.mozRequestAnimationFrame       || 
          window.oRequestAnimationFrame         || 
          window.msRequestAnimationFrame        || 
          function(/* function */ callback, /* DOMElement */ element){
            window.setTimeout(callback, 1000 / 60);
          };
        })();

        // Declare the canvas and rendering context
        canvas = document.getElementById("gameCanvas");
        ctx = canvas.getContext("2d");

        // Maximise the canvas
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;

        //just to test the canvas
        testplayer = {x: 300, y: 300};
        
        // Start listening to events
        window.addEventListener('deviceorientation', moveScreen);
      
        // Start Playing
        animate();

        // Start sending regular updates
        var clientUpdate = setInterval(function() {
          socket.emit('client update', playerData);
        }, 100);
      }



      function moveScreen(event) {
        var x = event.gamma;  // In degree in the range [-180,180]
        var y = event.beta; // In degree in the range [-90,90]
        velX  = (x !== undefined)? Math.round(x - localRefX) : 0;
        velY  = (y !== undefined)? Math.round(y - localRefY) : 0;
        playerData.posX = playerData.posX + velX;
        playerData.posY = playerData.posY + velY;
      }

      function animate() {
        update();
        draw();
        window.requestAnimFrame(animate);
      };

      function update() {
        //testplayer.x = testplayer.x + velX;
        //testplayer.y = testplayer.y + velY;
      }

      function draw() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        // just testing
        console.log(players);
        for (player in players) {
          console.log(players[player].data.posX);
          ctx.fillStyle = "red";
          ctx.fillRect(players[player].data.posX, players[player].data.posY, 100, 100);
        }

        ctx.fillStyle = "white";
        ctx.font = "20pt Arial";
        ctx.fillText(testplayer.x, 100, 100);
        ctx.fillText(testplayer.y, 100, 150);
        ctx.fillText(velX, 200, 100);
        ctx.fillText(velY, 200, 150);
      }

      //window.addEventListener('deviceorientation', handleOrientation);
    </script>
  </body>
</html>
